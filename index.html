<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Thoughtclock</title>
<style>
/* ═══════════════════════════════════════════════════════════
   THOUGHTCLOCK v2 — Timer Cockpit
   Design: 8-slot grid. Click to start. Click to stop.
   One glance = full picture of your day.
   ═══════════════════════════════════════════════════════════ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg-0: #0a0e14;
  --bg-1: #111820;
  --bg-2: #182030;
  --bg-3: #1e293b;
  --bg-hover: #243044;
  --border: #2a3545;
  --border-light: #374357;
  --text-1: #e8edf4;
  --text-2: #94a3b8;
  --text-3: #576881;
  --blue: #60a5fa;
  --green: #34d399;
  --green-dim: rgba(52,211,153,0.12);
  --amber: #fbbf24;
  --amber-dim: rgba(251,191,36,0.12);
  --red: #f87171;
  --red-dim: rgba(248,113,113,0.12);
  --purple: #a78bfa;
  --cyan: #22d3ee;
  --pink: #f472b6;
  --orange: #fb923c;
  --r-sm: 8px;
  --r-md: 12px;
  --r-lg: 16px;
  --r-xl: 20px;
  --shadow: 0 4px 24px rgba(0,0,0,0.35);
  --ease: cubic-bezier(0.4, 0, 0.2, 1);
  --mono: 'SF Mono','Cascadia Code','Fira Code','JetBrains Mono',monospace;
  --sans: -apple-system,BlinkMacSystemFont,'Segoe UI','Noto Sans',Helvetica,Arial,sans-serif;
}

html { font-size: 16px; }
body { font-family: var(--sans); background: var(--bg-0); color: var(--text-1); min-height: 100vh; line-height: 1.5; }

::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

/* ═══ BUTTONS ═══ */
.btn {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 8px 16px; border: 1px solid var(--border); border-radius: var(--r-sm);
  background: var(--bg-2); color: var(--text-1); font: 0.84rem var(--sans);
  cursor: pointer; transition: all 0.15s var(--ease); white-space: nowrap; outline: none;
}
.btn:hover { background: var(--bg-hover); border-color: var(--border-light); }
.btn:active { transform: scale(0.97); }
.btn svg { width: 15px; height: 15px; flex-shrink: 0; }
.btn-primary { background: var(--blue); border-color: var(--blue); color: #000; font-weight: 600; }
.btn-primary:hover { background: #79b5fb; }
.btn-green { background: var(--green); border-color: var(--green); color: #000; font-weight: 600; }
.btn-green:hover { background: #5de0b0; }
.btn-ghost { background: transparent; border-color: transparent; color: var(--text-2); padding: 6px 10px; }
.btn-ghost:hover { background: var(--bg-2); color: var(--text-1); }
.btn-sm { padding: 5px 10px; font-size: 0.78rem; }

/* ═══ FORM ═══ */
input, select, textarea {
  padding: 9px 12px; background: var(--bg-0); border: 1px solid var(--border); border-radius: var(--r-sm);
  color: var(--text-1); font: 0.88rem var(--sans); outline: none; transition: border-color 0.15s;
}
input:focus, select:focus, textarea:focus { border-color: var(--blue); box-shadow: 0 0 0 3px rgba(96,165,250,0.12); }
textarea { resize: vertical; min-height: 60px; width: 100%; font-family: var(--sans); }
label { display: block; font-size: 0.75rem; font-weight: 600; color: var(--text-3); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
.hint { font-size: 0.75rem; color: var(--text-3); margin-top: 3px; }
.hint a { color: var(--blue); }
.form-group { margin-bottom: 16px; }
.form-group input, .form-group select { width: 100%; }

/* ═══ SETUP ═══ */
.setup {
  display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 24px;
}
.setup.hidden { display: none; }
.setup-card {
  background: var(--bg-1); border: 1px solid var(--border); border-radius: var(--r-xl);
  padding: 36px; max-width: 440px; width: 100%; box-shadow: var(--shadow);
}
.setup-card h1 { font-size: 1.4rem; color: var(--cyan); margin-bottom: 4px; letter-spacing: -0.5px; }
.setup-card > p { color: var(--text-2); font-size: 0.85rem; margin-bottom: 24px; }

/* ═══ APP SHELL ═══ */
.app { display: none; }
.app.active { display: flex; flex-direction: column; min-height: 100vh; }

/* ─── Top bar ─── */
.topbar {
  position: sticky; top: 0; z-index: 100;
  background: rgba(17,24,32,0.85); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
  border-bottom: 1px solid var(--border);
  padding: 10px 24px; display: flex; align-items: center; justify-content: space-between;
}
.tb-left { display: flex; align-items: center; gap: 16px; }
.logo { font-weight: 700; font-size: 1rem; color: var(--cyan); display: flex; align-items: center; gap: 7px; letter-spacing: -0.3px; }
.logo svg { width: 20px; height: 20px; }

.tb-today {
  display: flex; align-items: center; gap: 10px;
  padding: 5px 14px; background: var(--bg-2); border: 1px solid var(--border); border-radius: var(--r-md);
}
.tb-today-label { font-size: 0.72rem; color: var(--text-3); text-transform: uppercase; letter-spacing: 0.5px; }
.tb-today-time { font-family: var(--mono); font-size: 1.1rem; font-weight: 700; color: var(--green); letter-spacing: 0.5px; }
.tb-progress { width: 80px; height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
.tb-progress-fill { height: 100%; border-radius: 2px; background: linear-gradient(90deg, var(--blue), var(--green)); transition: width 0.5s; }

.tb-right { display: flex; align-items: center; gap: 6px; }

/* ─── Main ─── */
.main { flex: 1; max-width: 1140px; width: 100%; margin: 0 auto; padding: 24px; }

/* ═══ SLOT GRID ═══ */
.slot-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(252px, 1fr));
  gap: 14px;
  margin-bottom: 28px;
}

/* ═══ TIMER CARD ═══ */
.card {
  background: var(--bg-1); border: 1px solid var(--border); border-radius: var(--r-lg);
  position: relative; overflow: hidden;
  transition: all 0.2s var(--ease);
  display: flex; flex-direction: column;
  min-height: 196px;
}
.card:hover { border-color: var(--border-light); }

/* Card states */
.card.running { border-color: var(--green); box-shadow: 0 0 0 1px var(--green), 0 0 24px rgba(52,211,153,0.08); }
.card.running .card-glow { position: absolute; top: 0; left: 0; right: 0; height: 2px; background: var(--green); }
.card.paused { border-color: var(--amber); }
.card.paused .card-glow { position: absolute; top: 0; left: 0; right: 0; height: 2px; background: var(--amber); }
.card.overtime { border-color: var(--red); box-shadow: 0 0 0 1px var(--red), 0 0 24px rgba(248,113,113,0.08); }
.card.overtime .card-glow { background: var(--red); }

/* Card header */
.card-head {
  padding: 14px 14px 0; display: flex; align-items: flex-start; justify-content: space-between; gap: 8px;
}
.card-type {
  width: 10px; height: 10px; border-radius: 3px; flex-shrink: 0; margin-top: 4px;
}
.card-head-left { display: flex; gap: 8px; min-width: 0; flex: 1; }
.card-head-text { min-width: 0; }
.card-title {
  font-size: 0.82rem; font-weight: 600; color: var(--text-2); font-family: var(--mono);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px;
}
.card-title a { color: var(--blue); text-decoration: none; }
.card-title a:hover { text-decoration: underline; }
.card-summary {
  font-size: 0.84rem; color: var(--text-1); margin-top: 2px;
  display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
  line-height: 1.35;
}
.card-remove {
  background: none; border: none; color: var(--text-3); cursor: pointer; padding: 2px;
  opacity: 0; transition: opacity 0.15s, color 0.15s; flex-shrink: 0;
}
.card:hover .card-remove { opacity: 1; }
.card-remove:hover { color: var(--red); }
.card-remove svg { width: 14px; height: 14px; }

/* Timer body — the big clickable area */
.card-timer-zone {
  flex: 1; display: flex; align-items: center; justify-content: center;
  padding: 8px 14px; cursor: pointer; user-select: none; position: relative;
}
.card-timer-zone:active { transform: scale(0.98); }
.card-timer {
  font-family: var(--mono); font-size: 2rem; font-weight: 700;
  letter-spacing: 2px; color: var(--text-3); transition: color 0.2s;
}
.card.running .card-timer { color: var(--green); }
.card.paused .card-timer { color: var(--amber); }

/* Click hint */
.card-hint {
  position: absolute; bottom: 4px; font-size: 0.68rem; color: var(--text-3);
  opacity: 0; transition: opacity 0.2s;
}
.card-timer-zone:hover .card-hint { opacity: 1; }

/* Meeting ring */
.meeting-ring-wrap {
  position: relative; display: flex; align-items: center; justify-content: center;
  cursor: pointer; user-select: none; padding: 8px 0;
}
.meeting-ring-wrap:active { transform: scale(0.98); }
.meeting-ring { transform: rotate(-90deg); }
.meeting-ring-bg { fill: none; stroke: var(--border); stroke-width: 4; }
.meeting-ring-fill { fill: none; stroke-width: 4; stroke-linecap: round; transition: stroke-dashoffset 1s linear, stroke 0.3s; }
.meeting-ring-text {
  position: absolute; display: flex; flex-direction: column; align-items: center;
  font-family: var(--mono);
}
.meeting-ring-time { font-size: 1.3rem; font-weight: 700; letter-spacing: 1px; }
.meeting-ring-expected { font-size: 0.68rem; color: var(--text-3); }
.meeting-ring-overtime { font-size: 0.72rem; color: var(--red); font-weight: 600; }

/* Card footer actions */
.card-actions {
  padding: 8px 14px 12px; display: flex; align-items: center; gap: 6px;
}
.card-action {
  width: 32px; height: 32px; border-radius: 50%; border: 1.5px solid var(--border);
  background: transparent; color: var(--text-3); cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.15s var(--ease); position: relative;
}
.card-action:hover { border-color: var(--text-2); color: var(--text-1); background: var(--bg-2); }
.card-action svg { width: 14px; height: 14px; }
.card-action.recording { border-color: var(--red); color: var(--red); animation: pulse-rec 1.5s infinite; }
@keyframes pulse-rec {
  0%, 100% { box-shadow: 0 0 0 0 rgba(248,113,113,0.4); }
  50% { box-shadow: 0 0 0 6px rgba(248,113,113,0); }
}

.card-action-log {
  margin-left: auto; border-radius: var(--r-sm); width: auto; height: auto;
  padding: 5px 12px; gap: 4px; font-size: 0.75rem; font-weight: 600;
  display: none; /* shown when timer has time */
}
.card-action-log.visible { display: inline-flex; }
.card-action-log.log-ready { border-color: var(--green); color: var(--green); }
.card-action-log.log-ready:hover { background: var(--green-dim); }

/* ═══ ADD CARD ═══ */
.card-add {
  background: transparent; border: 2px dashed var(--border); border-radius: var(--r-lg);
  min-height: 196px; display: flex; flex-direction: column; align-items: center; justify-content: center;
  cursor: pointer; transition: all 0.2s var(--ease); gap: 10px; padding: 20px;
}
.card-add:hover { border-color: var(--text-3); background: rgba(255,255,255,0.02); }
.card-add svg { width: 28px; height: 28px; color: var(--text-3); }
.card-add span { font-size: 0.82rem; color: var(--text-3); }

/* Add popover */
.add-popover {
  position: absolute; z-index: 50; top: 50%; left: 50%; transform: translate(-50%, -50%);
  background: var(--bg-1); border: 1px solid var(--border); border-radius: var(--r-lg);
  padding: 16px; width: 280px; box-shadow: var(--shadow);
  display: none;
}
.add-popover.open { display: block; }
.add-popover h4 { font-size: 0.85rem; margin-bottom: 12px; color: var(--text-1); }

.add-option {
  display: flex; align-items: center; gap: 10px; padding: 10px 12px;
  border: 1px solid transparent; border-radius: var(--r-sm); cursor: pointer;
  transition: all 0.12s; background: transparent;
  width: 100%; text-align: left; color: var(--text-1); font: 0.85rem var(--sans);
}
.add-option:hover { background: var(--bg-2); border-color: var(--border); }
.add-option .add-opt-icon {
  width: 32px; height: 32px; border-radius: var(--r-sm); display: flex;
  align-items: center; justify-content: center; flex-shrink: 0;
}
.add-option .add-opt-icon svg { width: 16px; height: 16px; }
.add-opt-text strong { display: block; font-size: 0.84rem; }
.add-opt-text span { font-size: 0.74rem; color: var(--text-3); }

/* Add sub-forms */
.add-form { display: none; padding-top: 12px; }
.add-form.open { display: block; }
.add-form .search-results {
  max-height: 180px; overflow-y: auto; margin-top: 8px; display: flex; flex-direction: column; gap: 2px;
}
.search-result {
  padding: 8px 10px; border-radius: var(--r-sm); cursor: pointer; transition: background 0.1s;
  display: flex; align-items: center; gap: 8px; font-size: 0.82rem;
  background: transparent; border: none; color: var(--text-1); width: 100%; text-align: left;
  font-family: var(--sans);
}
.search-result:hover { background: var(--bg-2); }
.search-result .sr-key { font-family: var(--mono); font-size: 0.75rem; color: var(--blue); font-weight: 600; white-space: nowrap; }
.search-result .sr-summary { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

/* ═══ TIMELINE BAR ═══ */
.timeline-section { margin-bottom: 24px; }
.timeline-label { font-size: 0.72rem; color: var(--text-3); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
.timeline-bar {
  height: 20px; background: var(--bg-2); border-radius: 10px; overflow: hidden;
  display: flex; position: relative;
}
.timeline-seg {
  height: 100%; transition: width 0.5s; display: flex; align-items: center; justify-content: center;
  font-size: 0.62rem; font-weight: 600; color: rgba(0,0,0,0.7); overflow: hidden; white-space: nowrap;
}

/* ═══ DAY LOG ═══ */
.daylog { margin-top: 8px; }
.daylog-header {
  display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;
  padding-bottom: 10px; border-bottom: 1px solid var(--border);
}
.daylog-header h3 { font-size: 0.95rem; }
.daylog-toggle { cursor: pointer; user-select: none; }

.log-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
.log-table th {
  text-align: left; padding: 7px 10px; font-size: 0.7rem; text-transform: uppercase;
  letter-spacing: 0.5px; color: var(--text-3); border-bottom: 1px solid var(--border); font-weight: 600;
}
.log-table td { padding: 9px 10px; border-bottom: 1px solid var(--border); color: var(--text-2); }
.log-table tr:hover td { background: rgba(255,255,255,0.015); }
.log-table .mono { font-family: var(--mono); color: var(--text-1); font-weight: 600; }
.log-table a { color: var(--blue); text-decoration: none; font-family: var(--mono); font-weight: 600; }
.log-table a:hover { text-decoration: underline; }

/* ═══ LOG MODAL ═══ */
.modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.55); backdrop-filter: blur(4px);
  z-index: 200; display: flex; align-items: center; justify-content: center;
  opacity: 0; pointer-events: none; transition: opacity 0.2s;
}
.modal-overlay.active { opacity: 1; pointer-events: all; }
.modal {
  background: var(--bg-1); border: 1px solid var(--border); border-radius: var(--r-xl);
  padding: 28px; max-width: 460px; width: 90%; box-shadow: var(--shadow);
  transform: translateY(8px); transition: transform 0.2s;
}
.modal-overlay.active .modal { transform: translateY(0); }
.modal h3 { font-size: 1rem; margin-bottom: 2px; }
.modal .modal-sub { color: var(--text-2); font-size: 0.82rem; margin-bottom: 18px; }
.modal .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.modal-footer { display: flex; gap: 8px; justify-content: flex-end; margin-top: 18px; }

/* ═══ VOICE MODAL ═══ */
.voice-big-btn {
  width: 72px; height: 72px; border-radius: 50%; border: 2px solid var(--border);
  background: var(--bg-2); color: var(--text-2); cursor: pointer;
  display: flex; align-items: center; justify-content: center; margin: 0 auto;
  transition: all 0.2s;
}
.voice-big-btn:hover { border-color: var(--text-2); color: var(--text-1); }
.voice-big-btn.recording { border-color: var(--red); color: var(--red); animation: pulse-rec 1.5s infinite; }
.voice-big-btn svg { width: 30px; height: 30px; }

/* ═══ TOAST ═══ */
.toasts { position: fixed; bottom: 20px; right: 20px; z-index: 300; display: flex; flex-direction: column; gap: 6px; }
.toast {
  background: var(--bg-1); border: 1px solid var(--border); border-radius: var(--r-md);
  padding: 10px 16px; box-shadow: var(--shadow); display: flex; align-items: center; gap: 8px;
  font-size: 0.82rem; animation: toast-in 0.25s; max-width: 320px;
}
.toast.ok { border-color: var(--green); }
.toast.err { border-color: var(--red); }
.toast.inf { border-color: var(--blue); }
@keyframes toast-in { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

/* ═══ SPINNER ═══ */
.spin { width: 16px; height: 16px; border: 2px solid var(--border); border-top-color: var(--blue); border-radius: 50%; animation: sp 0.5s linear infinite; display: inline-block; }
@keyframes sp { to { transform: rotate(360deg); } }

/* ═══ RESPONSIVE ═══ */
@media (max-width: 640px) {
  .topbar { padding: 8px 14px; flex-wrap: wrap; gap: 6px; }
  .main { padding: 14px; }
  .slot-grid { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; }
  .card { min-height: 170px; }
  .card-timer { font-size: 1.6rem; }
  .modal .form-row { grid-template-columns: 1fr; }
}

/* ═══ KBD ═══ */
kbd { display: inline-block; padding: 1px 5px; font: 0.68rem var(--mono); background: var(--bg-2); border: 1px solid var(--border); border-radius: 3px; color: var(--text-3); }
</style>
</head>
<body>

<!-- ═══ SETUP ═══ -->
<div class="setup" id="setup">
  <div class="setup-card">
    <h1>Thoughtclock</h1>
    <p>Connect your Jira Cloud. Credentials stay in your browser only.</p>
    <div class="form-group">
      <label>Jira Domain</label>
      <input type="text" id="cfgDomain" placeholder="company.atlassian.net">
      <div class="hint">Just the domain, no https://</div>
    </div>
    <div class="form-group">
      <label>Email</label>
      <input type="email" id="cfgEmail" placeholder="you@company.com">
    </div>
    <div class="form-group">
      <label>API Token</label>
      <input type="password" id="cfgToken" placeholder="Your Jira API token">
      <div class="hint">Generate at <a href="https://id.atlassian.com/manage-profile/security/api-tokens" target="_blank">id.atlassian.com</a></div>
    </div>
    <div class="form-group">
      <label>Daily Target (hours)</label>
      <input type="number" id="cfgTarget" value="8" min="1" max="24" step="0.5">
    </div>
    <button class="btn btn-primary" style="width:100%;justify-content:center;margin-top:4px" onclick="doConnect()">Connect & Load Tickets</button>
    <p class="hint" style="text-align:center;margin-top:12px">Stored in localStorage. Clear browser data to remove.</p>
  </div>
</div>

<!-- ═══ APP ═══ -->
<div class="app" id="app">
  <div class="topbar">
    <div class="tb-left">
      <div class="logo">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        Thoughtclock
      </div>
      <div class="tb-today">
        <span class="tb-today-label">Today</span>
        <span class="tb-today-time" id="elToday">0:00:00</span>
        <div class="tb-progress"><div class="tb-progress-fill" id="elProgress" style="width:0%"></div></div>
      </div>
    </div>
    <div class="tb-right">
      <button class="btn btn-sm" onclick="refreshJira()" title="Refresh tickets from Jira"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg> Refresh</button>
      <button class="btn btn-sm" onclick="toggleDayLog()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg> Day Log</button>
      <button class="btn btn-sm btn-ghost" onclick="doDisconnect()" title="Disconnect"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg></button>
    </div>
  </div>

  <div class="main">
    <!-- SLOT GRID -->
    <div class="slot-grid" id="slotGrid"></div>

    <!-- TIMELINE -->
    <div class="timeline-section">
      <div class="timeline-label">Time Distribution</div>
      <div class="timeline-bar" id="timeline"></div>
    </div>

    <!-- DAY LOG -->
    <div class="daylog" id="daylog" style="display:none">
      <div class="daylog-header">
        <h3>Today's Log</h3>
        <button class="btn btn-sm" onclick="exportCSV()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:13px;height:13px"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> CSV</button>
      </div>
      <table class="log-table">
        <thead><tr><th>Type</th><th>Name</th><th>Time</th><th>Comment</th><th>Status</th></tr></thead>
        <tbody id="logBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ═══ LOG MODAL ═══ -->
<div class="modal-overlay" id="logModal">
  <div class="modal">
    <h3>Log Time</h3>
    <p class="modal-sub" id="logModalSub"></p>
    <div class="form-row" style="margin-bottom:14px">
      <div class="form-group"><label>Hours</label><input type="number" id="logH" min="0" max="24" value="0"></div>
      <div class="form-group"><label>Minutes</label><input type="number" id="logM" min="0" max="59" value="0"></div>
    </div>
    <div class="form-group"><label>Comment</label><textarea id="logComment" placeholder="What did you work on?"></textarea></div>
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
      <input type="checkbox" id="logPostComment" style="width:auto">
      <label for="logPostComment" style="margin:0;text-transform:none;letter-spacing:0;font-weight:normal;font-size:0.82rem">Also post as Jira comment</label>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('logModal')">Cancel</button>
      <button class="btn btn-green" id="logSubmitBtn" onclick="submitTimeLog()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="width:14px;height:14px"><polyline points="20 6 9 17 4 12"/></svg> Log Time</button>
    </div>
  </div>
</div>

<!-- ═══ VOICE MODAL ═══ -->
<div class="modal-overlay" id="voiceModal">
  <div class="modal">
    <h3>Voice Comment</h3>
    <p class="modal-sub" id="voiceModalSub"></p>
    <div style="text-align:center;padding:16px 0">
      <button class="voice-big-btn" id="voiceBtn" onclick="toggleVoice()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
      </button>
      <p style="margin-top:10px;font-size:0.8rem;color:var(--text-3)" id="voiceStatus">Click to record</p>
    </div>
    <div class="form-group"><label>Transcript</label><textarea id="voiceText" placeholder="Speech appears here. You can edit too." rows="3"></textarea></div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('voiceModal')">Cancel</button>
      <button class="btn btn-primary" id="voiceSubmitBtn" onclick="submitVoice()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:14px;height:14px"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg> Post Comment</button>
    </div>
  </div>
</div>

<div class="toasts" id="toasts"></div>

<script>
// ═══════════════════════════════════════════════════════════
//  CONSTANTS
// ═══════════════════════════════════════════════════════════
const COLORS = ['#60a5fa','#34d399','#a78bfa','#fb923c','#22d3ee','#f472b6','#fbbf24','#94a3b8'];
const MAX_SLOTS = 8;
const MEETING_PRESETS = [
  { name: 'Standup', mins: 15 },
  { name: '1:1', mins: 30 },
  { name: 'Sprint Planning', mins: 60 },
  { name: 'Retrospective', mins: 60 },
  { name: 'Workshop', mins: 90 },
];
const SVG = {
  play: '<svg viewBox="0 0 24 24" fill="currentColor"><polygon points="6 3 20 12 6 21 6 3"/></svg>',
  pause: '<svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>',
  mic: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/><path d="M19 10v2a7 7 0 01-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>',
  check: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>',
  x: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
  plus: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',
  log: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>',
};

// ═══════════════════════════════════════════════════════════
//  STATE
// ═══════════════════════════════════════════════════════════
let S = {
  config: null,
  slots: [],        // { id, type:'jira'|'quick'|'meeting', key, title, summary, color, meetingMins, timer:{elapsed,running,startedAt} }
  jiraCache: [],    // cached ticket list from Jira
  dayLog: [],       // { id, type, key, title, seconds, comment, loggedAt, synced }
  voiceSlotId: null,
  logSlotId: null,
  recognition: null,
  isRecording: false,
  addOpen: false,
};

// ═══════════════════════════════════════════════════════════
//  INIT
// ═══════════════════════════════════════════════════════════
function init() {
  const cfg = localStorage.getItem('tc2_config');
  if (cfg) {
    S.config = JSON.parse(cfg);
    document.getElementById('cfgDomain').value = S.config.domain;
    document.getElementById('cfgEmail').value = S.config.email;
    document.getElementById('cfgToken').value = S.config.token;
    document.getElementById('cfgTarget').value = S.config.dailyTarget || 8;
    showApp();
    loadJiraTickets();
  }

  // Restore slots
  const ss = localStorage.getItem('tc2_slots');
  if (ss) {
    S.slots = JSON.parse(ss);
    // Recalculate running timers
    S.slots.forEach(s => {
      if (s.timer.running && s.timer.startedAt) {
        // Timer was running when page closed — keep the startedAt, elapsed stays as-is
        // The tick function will calculate the live total
      }
    });
  }

  // Restore day log
  const dl = localStorage.getItem('tc2_log_' + todayKey());
  if (dl) S.dayLog = JSON.parse(dl);

  render();
  setInterval(tick, 1000);
  setInterval(saveState, 3000);

  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') { closeModal('logModal'); closeModal('voiceModal'); closeAddPopover(); }
    // 1-8 toggle timers
    if (!e.ctrlKey && !e.metaKey && !e.altKey && e.key >= '1' && e.key <= '8') {
      const el = document.activeElement;
      if (el && (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.tagName === 'SELECT')) return;
      const idx = parseInt(e.key) - 1;
      if (S.slots[idx]) toggleTimer(S.slots[idx].id);
    }
  });

  // Click outside add popover
  document.addEventListener('click', e => {
    if (S.addOpen && !e.target.closest('.card-add')) closeAddPopover();
  });
}

function todayKey() { return new Date().toISOString().split('T')[0]; }
function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2, 7); }
function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
function fmtTime(s) { const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), sec=s%60; return `${h}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`; }
function fmtHM(s) { const h=Math.floor(s/3600), m=Math.floor((s%3600)/60); return h>0?`${h}h ${m}m`:`${m}m`; }

// ═══════════════════════════════════════════════════════════
//  CONNECTION
// ═══════════════════════════════════════════════════════════
function doConnect() {
  const domain = document.getElementById('cfgDomain').value.trim().replace(/^https?:\/\//,'').replace(/\/$/,'');
  const email = document.getElementById('cfgEmail').value.trim();
  const token = document.getElementById('cfgToken').value.trim();
  const dailyTarget = parseFloat(document.getElementById('cfgTarget').value) || 8;
  if (!domain || !email || !token) { toast('Fill all fields','err'); return; }
  S.config = { domain, email, token, dailyTarget };
  localStorage.setItem('tc2_config', JSON.stringify(S.config));
  showApp();
  loadJiraTickets();
}

function doDisconnect() {
  if (!confirm('Disconnect? Timer state will be cleared.')) return;
  localStorage.removeItem('tc2_config');
  localStorage.removeItem('tc2_slots');
  S.config = null; S.slots = []; S.jiraCache = [];
  document.getElementById('app').classList.remove('active');
  document.getElementById('setup').classList.remove('hidden');
}

function showApp() {
  document.getElementById('setup').classList.add('hidden');
  document.getElementById('app').classList.add('active');
}

// ═══════════════════════════════════════════════════════════
//  JIRA API
// ═══════════════════════════════════════════════════════════
async function jira(path, opts = {}) {
  const { domain, email, token } = S.config;
  const r = await fetch(`https://${domain}${path}`, {
    ...opts,
    headers: { 'Authorization': 'Basic ' + btoa(email+':'+token), 'Content-Type': 'application/json', 'Accept': 'application/json', ...(opts.headers||{}) },
  });
  if (!r.ok) throw new Error(`Jira ${r.status}: ${(await r.text()).slice(0,150)}`);
  return r.status === 204 ? null : r.json();
}

async function loadJiraTickets() {
  try {
    const jql = encodeURIComponent('assignee = currentUser() AND statusCategory != Done ORDER BY updated DESC');
    const data = await jira(`/rest/api/3/search?jql=${jql}&fields=summary,status,issuetype,priority,project&maxResults=50`);
    S.jiraCache = (data.issues || []).map(i => ({
      key: i.key,
      summary: i.fields.summary,
      status: i.fields.status?.name || '',
      type: i.fields.issuetype?.name || 'Task',
      priority: i.fields.priority?.name || 'Medium',
      project: i.fields.project?.key || '',
    }));
    toast(`${S.jiraCache.length} tickets loaded`, 'ok');
  } catch (e) {
    toast('Jira load failed: ' + e.message, 'err');
  }
}

async function refreshJira() { await loadJiraTickets(); }

// ═══════════════════════════════════════════════════════════
//  SLOT MANAGEMENT
// ═══════════════════════════════════════════════════════════
function addJiraSlot(ticket) {
  if (S.slots.length >= MAX_SLOTS) { toast('Max 8 slots','err'); return; }
  if (S.slots.find(s => s.key === ticket.key)) { toast(`${ticket.key} already on board`,'inf'); return; }
  S.slots.push({
    id: uid(), type: 'jira', key: ticket.key,
    title: ticket.key, summary: ticket.summary,
    color: COLORS[S.slots.length % COLORS.length],
    meetingMins: null,
    timer: { elapsed: 0, running: false, startedAt: null },
  });
  saveState(); render(); closeAddPopover();
}

function addQuickSlot(name) {
  if (S.slots.length >= MAX_SLOTS) { toast('Max 8 slots','err'); return; }
  if (!name.trim()) return;
  S.slots.push({
    id: uid(), type: 'quick', key: null,
    title: name.trim(), summary: '',
    color: COLORS[S.slots.length % COLORS.length],
    meetingMins: null,
    timer: { elapsed: 0, running: false, startedAt: null },
  });
  saveState(); render(); closeAddPopover();
}

function addMeetingSlot(name, mins) {
  if (S.slots.length >= MAX_SLOTS) { toast('Max 8 slots','err'); return; }
  if (!name.trim()) return;
  S.slots.push({
    id: uid(), type: 'meeting', key: null,
    title: name.trim(), summary: `${mins}min meeting`,
    color: COLORS[S.slots.length % COLORS.length],
    meetingMins: mins,
    timer: { elapsed: 0, running: false, startedAt: null },
  });
  saveState(); render(); closeAddPopover();
}

function removeSlot(id) {
  const s = S.slots.find(x => x.id === id);
  if (s && s.timer.running) pauseSlotTimer(s);
  S.slots = S.slots.filter(x => x.id !== id);
  saveState(); render();
}

// ═══════════════════════════════════════════════════════════
//  TIMERS
// ═══════════════════════════════════════════════════════════
function toggleTimer(id) {
  const s = S.slots.find(x => x.id === id);
  if (!s) return;
  if (s.timer.running) {
    pauseSlotTimer(s);
  } else {
    s.timer.running = true;
    s.timer.startedAt = Date.now();
  }
  render();
}

function pauseSlotTimer(s) {
  if (!s.timer.running) return;
  s.timer.elapsed += Math.floor((Date.now() - s.timer.startedAt) / 1000);
  s.timer.running = false;
  s.timer.startedAt = null;
}

function getElapsed(s) {
  let t = s.timer.elapsed;
  if (s.timer.running && s.timer.startedAt) t += Math.floor((Date.now() - s.timer.startedAt) / 1000);
  return t;
}

function tick() {
  S.slots.forEach(s => {
    const el = document.getElementById('t-' + s.id);
    if (el) el.textContent = fmtTime(getElapsed(s));

    // Meeting ring
    if (s.type === 'meeting' && s.meetingMins) {
      updateMeetingRing(s);
    }

    // Card state class
    const card = document.getElementById('c-' + s.id);
    if (card) {
      card.classList.toggle('running', s.timer.running);
      card.classList.toggle('paused', !s.timer.running && s.timer.elapsed > 0);
      if (s.type === 'meeting' && s.meetingMins) {
        const overtime = getElapsed(s) > s.meetingMins * 60;
        card.classList.toggle('overtime', overtime && s.timer.running);
      }
    }

    // Log button visibility
    const lb = document.getElementById('lb-' + s.id);
    if (lb) lb.classList.toggle('visible', getElapsed(s) >= 60);
    if (lb) lb.classList.toggle('log-ready', getElapsed(s) >= 60 && !s.timer.running);
  });

  updateTopbar();
  updateTimeline();
}

function updateMeetingRing(s) {
  const fill = document.getElementById('rf-' + s.id);
  const timeEl = document.getElementById('rt-' + s.id);
  const otEl = document.getElementById('ro-' + s.id);
  if (!fill) return;

  const elapsed = getElapsed(s);
  const total = s.meetingMins * 60;
  const pct = Math.min(elapsed / total, 1);
  const C = 2 * Math.PI * 42; // circumference
  fill.style.strokeDashoffset = C * (1 - pct);

  if (elapsed <= total * 0.8) fill.style.stroke = 'var(--green)';
  else if (elapsed <= total) fill.style.stroke = 'var(--amber)';
  else fill.style.stroke = 'var(--red)';

  if (timeEl) timeEl.textContent = fmtTime(elapsed);
  if (otEl) {
    if (elapsed > total) {
      otEl.textContent = '+' + fmtHM(elapsed - total) + ' over';
      otEl.style.display = 'block';
    } else {
      otEl.style.display = 'none';
    }
  }
}

function updateTopbar() {
  let total = 0;
  S.slots.forEach(s => { total += getElapsed(s); });
  S.dayLog.forEach(l => { total += l.seconds; });
  document.getElementById('elToday').textContent = fmtTime(total);
  const target = (S.config?.dailyTarget || 8) * 3600;
  document.getElementById('elProgress').style.width = Math.min(100, Math.round(total / target * 100)) + '%';
}

function updateTimeline() {
  const bar = document.getElementById('timeline');
  const target = (S.config?.dailyTarget || 8) * 3600;

  // Collect all time entries
  const entries = [];
  S.slots.forEach(s => {
    const secs = getElapsed(s);
    if (secs > 0) entries.push({ title: s.title, color: s.color, seconds: secs });
  });
  S.dayLog.forEach(l => {
    entries.push({ title: l.title, color: '#576881', seconds: l.seconds });
  });

  let html = '';
  entries.forEach(e => {
    const pct = Math.max(1, (e.seconds / target) * 100);
    html += `<div class="timeline-seg" style="width:${pct}%;background:${e.color}" title="${esc(e.title)}: ${fmtHM(e.seconds)}">${pct > 6 ? esc(e.title) : ''}</div>`;
  });
  bar.innerHTML = html;
}

// ═══════════════════════════════════════════════════════════
//  RENDER
// ═══════════════════════════════════════════════════════════
function render() {
  const grid = document.getElementById('slotGrid');
  grid.innerHTML = '';

  S.slots.forEach((s, i) => {
    const el = getElapsed(s);
    const isRun = s.timer.running;
    const isPaused = !isRun && el > 0;

    const card = document.createElement('div');
    card.className = 'card' + (isRun ? ' running' : '') + (isPaused ? ' paused' : '') +
      (s.type === 'meeting' && s.meetingMins && el > s.meetingMins * 60 && isRun ? ' overtime' : '');
    card.id = 'c-' + s.id;

    const typeColor = s.type === 'jira' ? 'var(--blue)' : s.type === 'meeting' ? 'var(--purple)' : 'var(--cyan)';
    const typeLabel = s.type === 'jira' ? 'Jira' : s.type === 'meeting' ? 'Meeting' : 'Quick';

    let titleHtml;
    if (s.type === 'jira' && S.config) {
      titleHtml = `<a href="https://${S.config.domain}/browse/${s.key}" target="_blank" onclick="event.stopPropagation()">${esc(s.title)}</a>`;
    } else {
      titleHtml = esc(s.title);
    }

    let timerZone;
    if (s.type === 'meeting' && s.meetingMins) {
      const C = 2 * Math.PI * 42;
      const pct = Math.min(el / (s.meetingMins * 60), 1);
      let ringColor = 'var(--green)';
      if (el > s.meetingMins * 60) ringColor = 'var(--red)';
      else if (el > s.meetingMins * 60 * 0.8) ringColor = 'var(--amber)';

      timerZone = `
        <div class="meeting-ring-wrap" onclick="toggleTimer('${s.id}')">
          <svg class="meeting-ring" width="100" height="100" viewBox="0 0 100 100">
            <circle class="meeting-ring-bg" cx="50" cy="50" r="42"/>
            <circle class="meeting-ring-fill" id="rf-${s.id}" cx="50" cy="50" r="42"
              stroke="${ringColor}" stroke-dasharray="${C} ${C}" stroke-dashoffset="${C * (1 - pct)}"/>
          </svg>
          <div class="meeting-ring-text">
            <span class="meeting-ring-time" id="rt-${s.id}" style="color:${isRun ? ringColor : isPaused ? 'var(--amber)' : 'var(--text-3)'}">${fmtTime(el)}</span>
            <span class="meeting-ring-expected">/ ${s.meetingMins}m</span>
            <span class="meeting-ring-overtime" id="ro-${s.id}" style="display:${el > s.meetingMins*60 ? 'block' : 'none'}">+${fmtHM(Math.max(0, el - s.meetingMins*60))} over</span>
          </div>
          <span class="card-hint">${isRun ? 'click to pause' : 'click to start'}</span>
        </div>`;
    } else {
      timerZone = `
        <div class="card-timer-zone" onclick="toggleTimer('${s.id}')">
          <span class="card-timer" id="t-${s.id}">${fmtTime(el)}</span>
          <span class="card-hint">${isRun ? 'click to pause' : 'click to start'}</span>
        </div>`;
    }

    card.innerHTML = `
      <div class="card-glow"></div>
      <div class="card-head">
        <div class="card-head-left">
          <div class="card-type" style="background:${typeColor}" title="${typeLabel}"></div>
          <div class="card-head-text">
            <div class="card-title">${titleHtml}</div>
            ${s.summary ? `<div class="card-summary">${esc(s.summary)}</div>` : ''}
          </div>
        </div>
        <button class="card-remove" onclick="event.stopPropagation();removeSlot('${s.id}')" title="Remove">${SVG.x}</button>
      </div>
      ${timerZone}
      <div class="card-actions">
        <button class="card-action" onclick="event.stopPropagation();toggleTimer('${s.id}')" title="${isRun ? 'Pause' : 'Start'} (${i+1})">
          ${isRun ? SVG.pause : SVG.play}
        </button>
        <button class="card-action" onclick="event.stopPropagation();openVoice('${s.id}')" title="Voice comment">
          ${SVG.mic}
        </button>
        <button class="card-action card-action-log ${el >= 60 ? 'visible' : ''} ${el >= 60 && !isRun ? 'log-ready' : ''}" id="lb-${s.id}"
          onclick="event.stopPropagation();openLog('${s.id}')" title="Log time">
          ${SVG.check} Log
        </button>
      </div>
      <div style="position:absolute;bottom:6px;left:14px;font-size:0.62rem;color:var(--text-3);opacity:0.5"><kbd>${i+1}</kbd></div>
    `;
    grid.appendChild(card);
  });

  // Add card (if room)
  if (S.slots.length < MAX_SLOTS) {
    const add = document.createElement('div');
    add.className = 'card-add';
    add.id = 'addCard';
    add.onclick = (e) => { e.stopPropagation(); openAddPopover(); };
    add.innerHTML = `
      ${SVG.plus}
      <span>Add Timer (${S.slots.length}/${MAX_SLOTS})</span>
      <div class="add-popover" id="addPopover">
        <h4>Add to dashboard</h4>
        <button class="add-option" onclick="event.stopPropagation();showAddForm('jira')">
          <div class="add-opt-icon" style="background:rgba(96,165,250,0.15);color:var(--blue)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="9" y1="3" x2="9" y2="21"/></svg></div>
          <div class="add-opt-text"><strong>Jira Ticket</strong><span>Pick from your open tickets</span></div>
        </button>
        <button class="add-option" onclick="event.stopPropagation();showAddForm('quick')">
          <div class="add-opt-icon" style="background:rgba(34,211,238,0.15);color:var(--cyan)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg></div>
          <div class="add-opt-text"><strong>Quick Task</strong><span>Ad-hoc work, email, review</span></div>
        </button>
        <button class="add-option" onclick="event.stopPropagation();showAddForm('meeting')">
          <div class="add-opt-icon" style="background:rgba(167,139,250,0.15);color:var(--purple)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg></div>
          <div class="add-opt-text"><strong>Meeting</strong><span>With countdown timer</span></div>
        </button>

        <!-- Jira search form -->
        <div class="add-form" id="addFormJira">
          <input type="text" id="jiraSearch" placeholder="Search tickets..." oninput="filterJiraResults()" style="width:100%" autocomplete="off">
          <div class="search-results" id="jiraResults"></div>
        </div>

        <!-- Quick task form -->
        <div class="add-form" id="addFormQuick">
          <input type="text" id="quickName" placeholder="Task name (e.g. Email cleanup)" style="width:100%" autocomplete="off">
          <button class="btn btn-primary btn-sm" style="margin-top:8px;width:100%;justify-content:center" onclick="event.stopPropagation();addQuickSlot(document.getElementById('quickName').value)">Add Quick Task</button>
        </div>

        <!-- Meeting form -->
        <div class="add-form" id="addFormMeeting">
          <input type="text" id="meetingName" placeholder="Meeting name" style="width:100%;margin-bottom:8px" autocomplete="off">
          <label>Preset or custom</label>
          <div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px">
            ${MEETING_PRESETS.map(p => `<button class="btn btn-sm" onclick="event.stopPropagation();pickMeetingPreset('${p.name}',${p.mins})">${p.name} (${p.mins}m)</button>`).join('')}
          </div>
          <div style="display:flex;gap:6px;align-items:end">
            <div style="flex:1"><label>Minutes</label><input type="number" id="meetingMins" value="30" min="5" max="480" style="width:100%"></div>
            <button class="btn btn-primary btn-sm" onclick="event.stopPropagation();addMeetingSlot(document.getElementById('meetingName').value, parseInt(document.getElementById('meetingMins').value)||30)">Add</button>
          </div>
        </div>
      </div>
    `;
    grid.appendChild(add);
  }

  updateTimeline();
}

// ═══════════════════════════════════════════════════════════
//  ADD POPOVER
// ═══════════════════════════════════════════════════════════
function openAddPopover() {
  S.addOpen = true;
  const pop = document.getElementById('addPopover');
  if (pop) pop.classList.add('open');
  // Reset forms
  document.querySelectorAll('.add-form').forEach(f => f.classList.remove('open'));
}

function closeAddPopover() {
  S.addOpen = false;
  const pop = document.getElementById('addPopover');
  if (pop) pop.classList.remove('open');
}

function showAddForm(type) {
  document.querySelectorAll('.add-form').forEach(f => f.classList.remove('open'));
  const form = document.getElementById('addForm' + type.charAt(0).toUpperCase() + type.slice(1));
  if (form) {
    form.classList.add('open');
    const input = form.querySelector('input');
    if (input) { input.value = ''; setTimeout(() => input.focus(), 50); }
  }
  if (type === 'jira') renderJiraResults('');

  // Enter key for quick task
  const qn = document.getElementById('quickName');
  if (qn) qn.onkeydown = e => { if (e.key === 'Enter') { e.stopPropagation(); addQuickSlot(qn.value); } };

  // Enter key for meeting
  const mn = document.getElementById('meetingName');
  if (mn) mn.onkeydown = e => { if (e.key === 'Enter') { e.stopPropagation(); addMeetingSlot(mn.value, parseInt(document.getElementById('meetingMins').value)||30); } };
}

function pickMeetingPreset(name, mins) {
  document.getElementById('meetingName').value = name;
  document.getElementById('meetingMins').value = mins;
}

function filterJiraResults() {
  renderJiraResults(document.getElementById('jiraSearch').value);
}

function renderJiraResults(query) {
  const container = document.getElementById('jiraResults');
  const q = query.toLowerCase().trim();
  let tickets = S.jiraCache;
  if (q) tickets = tickets.filter(t => t.key.toLowerCase().includes(q) || t.summary.toLowerCase().includes(q));
  tickets = tickets.slice(0, 12);

  if (tickets.length === 0) {
    container.innerHTML = `<div style="padding:12px;text-align:center;color:var(--text-3);font-size:0.8rem">${S.jiraCache.length === 0 ? 'No tickets loaded. Click Refresh.' : 'No matches'}</div>`;
    return;
  }

  container.innerHTML = tickets.map(t => `
    <button class="search-result" onclick="event.stopPropagation();addJiraSlot(${JSON.stringify(t).replace(/"/g,'&quot;')})">
      <span class="sr-key">${esc(t.key)}</span>
      <span class="sr-summary">${esc(t.summary)}</span>
    </button>
  `).join('');
}

// ═══════════════════════════════════════════════════════════
//  LOG TIME
// ═══════════════════════════════════════════════════════════
function openLog(id) {
  const s = S.slots.find(x => x.id === id);
  if (!s) return;
  if (s.timer.running) pauseSlotTimer(s);
  render();

  S.logSlotId = id;
  const secs = getElapsed(s);
  document.getElementById('logModalSub').textContent = s.type === 'jira' ? `${s.key}: ${s.summary}` : s.title;
  document.getElementById('logH').value = Math.floor(secs / 3600);
  document.getElementById('logM').value = Math.floor((secs % 3600) / 60);
  document.getElementById('logComment').value = '';
  document.getElementById('logPostComment').checked = false;
  // Hide "also post comment" for non-jira
  document.getElementById('logPostComment').parentElement.style.display = s.type === 'jira' ? '' : 'none';
  openModal('logModal');
}

async function submitTimeLog() {
  const s = S.slots.find(x => x.id === S.logSlotId);
  if (!s) return;

  const h = parseInt(document.getElementById('logH').value) || 0;
  const m = parseInt(document.getElementById('logM').value) || 0;
  const totalSec = h * 3600 + m * 60;
  const comment = document.getElementById('logComment').value.trim();
  const alsoComment = document.getElementById('logPostComment').checked;

  if (totalSec < 60) { toast('Log at least 1 minute','err'); return; }

  const btn = document.getElementById('logSubmitBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spin"></span> Logging...';

  let synced = false;
  try {
    if (s.type === 'jira' && s.key) {
      const payload = {
        timeSpentSeconds: totalSec,
        started: new Date().toISOString().replace('Z','+0000'),
      };
      if (comment) {
        payload.comment = { type:'doc', version:1, content:[{ type:'paragraph', content:[{type:'text',text:comment}] }] };
      }
      await jira(`/rest/api/3/issue/${s.key}/worklog`, { method:'POST', body:JSON.stringify(payload) });
      if (alsoComment && comment) {
        await jira(`/rest/api/3/issue/${s.key}/comment`, {
          method:'POST', body:JSON.stringify({ body:{ type:'doc', version:1, content:[{type:'paragraph',content:[{type:'text',text:comment}]}] } })
        });
      }
      synced = true;
    }
    toast(`Logged ${fmtHM(totalSec)}${s.key ? ' to '+s.key : ''}`, 'ok');
  } catch (e) {
    toast('Jira log failed: ' + e.message, 'err');
    if (s.type === 'jira') toast('Saved locally','inf');
  }

  // Save to day log
  S.dayLog.push({
    id: uid(), type: s.type, key: s.key, title: s.title,
    seconds: totalSec, comment, loggedAt: new Date().toISOString(), synced,
  });
  saveDayLog();

  // Reset timer
  s.timer = { elapsed: 0, running: false, startedAt: null };
  saveState(); render();
  closeModal('logModal');

  btn.disabled = false;
  btn.innerHTML = SVG.check + ' Log Time';
}

// ═══════════════════════════════════════════════════════════
//  VOICE
// ═══════════════════════════════════════════════════════════
function openVoice(id) {
  const s = S.slots.find(x => x.id === id);
  if (!s) return;
  S.voiceSlotId = id;
  document.getElementById('voiceModalSub').textContent = s.type === 'jira' ? `${s.key}: ${s.summary}` : s.title;
  document.getElementById('voiceText').value = '';
  document.getElementById('voiceStatus').textContent = 'Click to record';
  document.getElementById('voiceBtn').classList.remove('recording');
  S.isRecording = false;
  openModal('voiceModal');
}

function toggleVoice() {
  if (S.isRecording) stopVoice();
  else startVoice();
}

function startVoice() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) { toast('Use Chrome or Edge for voice','err'); return; }
  S.recognition = new SR();
  S.recognition.continuous = true;
  S.recognition.interimResults = true;
  S.recognition.lang = 'en-US';
  let final = document.getElementById('voiceText').value;
  S.recognition.onresult = ev => {
    let interim = '';
    for (let i = ev.resultIndex; i < ev.results.length; i++) {
      if (ev.results[i].isFinal) final += ev.results[i][0].transcript + ' ';
      else interim += ev.results[i][0].transcript;
    }
    document.getElementById('voiceText').value = final + interim;
  };
  S.recognition.onerror = ev => { if (ev.error !== 'aborted') toast('Voice error: '+ev.error,'err'); stopVoice(); };
  S.recognition.onend = () => { if (S.isRecording) try { S.recognition.start(); } catch(e){} };
  try {
    S.recognition.start();
    S.isRecording = true;
    document.getElementById('voiceBtn').classList.add('recording');
    document.getElementById('voiceStatus').textContent = 'Listening... click to stop';
  } catch(e) { toast('Mic error: '+e.message,'err'); }
}

function stopVoice() {
  S.isRecording = false;
  if (S.recognition) try { S.recognition.stop(); } catch(e){}
  S.recognition = null;
  document.getElementById('voiceBtn').classList.remove('recording');
  document.getElementById('voiceStatus').textContent = 'Click to record again';
}

async function submitVoice() {
  const s = S.slots.find(x => x.id === S.voiceSlotId);
  const text = document.getElementById('voiceText').value.trim();
  if (!s || !text) { toast('No text to post','err'); return; }

  const btn = document.getElementById('voiceSubmitBtn');
  btn.disabled = true; btn.innerHTML = '<span class="spin"></span> Posting...';
  try {
    if (s.type === 'jira' && s.key) {
      await jira(`/rest/api/3/issue/${s.key}/comment`, {
        method:'POST', body:JSON.stringify({ body:{ type:'doc', version:1, content:[{type:'paragraph',content:[{type:'text',text:text}]}] } })
      });
      toast(`Comment posted to ${s.key}`,'ok');
    } else {
      toast('Comment saved locally (no Jira ticket)','inf');
    }
    closeModal('voiceModal');
  } catch(e) {
    toast('Post failed: '+e.message,'err');
  }
  btn.disabled = false;
  btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:14px;height:14px"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg> Post Comment';
}

// ═══════════════════════════════════════════════════════════
//  DAY LOG
// ═══════════════════════════════════════════════════════════
function saveDayLog() { localStorage.setItem('tc2_log_' + todayKey(), JSON.stringify(S.dayLog)); }

function toggleDayLog() {
  const el = document.getElementById('daylog');
  const vis = el.style.display !== 'none';
  el.style.display = vis ? 'none' : 'block';
  if (!vis) renderDayLog();
}

function renderDayLog() {
  const tb = document.getElementById('logBody');
  if (S.dayLog.length === 0) {
    tb.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px;color:var(--text-3)">No entries yet</td></tr>';
    return;
  }
  tb.innerHTML = S.dayLog.map(l => {
    const typeLabel = l.type === 'jira' ? 'Jira' : l.type === 'meeting' ? 'Meeting' : 'Quick';
    const typeColor = l.type === 'jira' ? 'var(--blue)' : l.type === 'meeting' ? 'var(--purple)' : 'var(--cyan)';
    const nameHtml = l.key && S.config ? `<a href="https://${S.config.domain}/browse/${l.key}" target="_blank">${esc(l.key)}</a> ${esc(l.title.replace(l.key,''))}` : esc(l.title);
    return `<tr>
      <td><span style="color:${typeColor};font-weight:600;font-size:0.78rem">${typeLabel}</span></td>
      <td style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${nameHtml}</td>
      <td class="mono">${fmtHM(l.seconds)}</td>
      <td style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(l.comment||'-')}</td>
      <td>${l.synced ? '<span style="color:var(--green)">Synced</span>' : '<span style="color:var(--amber)">Local</span>'}</td>
    </tr>`;
  }).join('');
}

function exportCSV() {
  const rows = [['Type','Key','Title','Hours','Minutes','Comment','Time','Synced']];
  S.dayLog.forEach(l => {
    rows.push([l.type, l.key||'', `"${l.title.replace(/"/g,'""')}"`, Math.floor(l.seconds/3600), Math.floor((l.seconds%3600)/60), `"${(l.comment||'').replace(/"/g,'""')}"`, l.loggedAt, l.synced?'Yes':'No']);
  });
  const csv = rows.map(r=>r.join(',')).join('\n');
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  a.download = `thoughtclock_${todayKey()}.csv`;
  a.click();
  toast('CSV exported','ok');
}

// ═══════════════════════════════════════════════════════════
//  MODALS
// ═══════════════════════════════════════════════════════════
function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); if (id==='voiceModal') stopVoice(); }

// ═══════════════════════════════════════════════════════════
//  PERSISTENCE
// ═══════════════════════════════════════════════════════════
function saveState() { localStorage.setItem('tc2_slots', JSON.stringify(S.slots)); }

// ═══════════════════════════════════════════════════════════
//  TOAST
// ═══════════════════════════════════════════════════════════
function toast(msg, type='inf') {
  const c = document.getElementById('toasts');
  const el = document.createElement('div');
  el.className = 'toast ' + type;
  const icons = {
    ok: '<svg viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2.5" style="width:16px;height:16px;flex-shrink:0"><polyline points="20 6 9 17 4 12"/></svg>',
    err: '<svg viewBox="0 0 24 24" fill="none" stroke="var(--red)" stroke-width="2" style="width:16px;height:16px;flex-shrink:0"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
    inf: '<svg viewBox="0 0 24 24" fill="none" stroke="var(--blue)" stroke-width="2" style="width:16px;height:16px;flex-shrink:0"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>',
  };
  el.innerHTML = (icons[type]||icons.inf) + ' ' + esc(msg);
  c.appendChild(el);
  setTimeout(() => { el.style.opacity='0'; el.style.transform='translateX(100%)'; el.style.transition='all 0.3s'; setTimeout(()=>el.remove(),300); }, 3500);
}

// ═══════════════════════════════════════════════════════════
//  BOOT
// ═══════════════════════════════════════════════════════════
init();
</script>
</body>
</html>
